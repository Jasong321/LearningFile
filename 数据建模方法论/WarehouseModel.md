# 数仓建模基础概念

## 键

###  键的归类

![image-20211103220642064](https://raw.githubusercontent.com/Jasong321/PicBed/master/202111071127748.png)

### 候选键，主键和可选键

1、候选键

一个或者多个属性的组合，可以唯一确定实体的一个实例

2、主键

从候选键中，选中用来作为唯一标识的属性或者属性组，被称为主键。

3、可选键

候选键中，没有选中的其他键，称为可选键

#### 主键的特点

1. 唯一性，不可重复
2. 强制性，不可以为空
3. 永久性，不可改变
4. 最小集合，不可掺杂多余的属性

主键设计的其他建议：

1、除非真的可以预估到未来的变化，否则不要弄smart key（身份证就是smart key，设计不合理导致号码不够用，身份证从1代升级为2代就是为了解决这个问题）。

问题与隐患：

- 将编码植入程序
- 未来变化无法应对

2、不能随着环境的变化而受到影响，要考虑各方面以及未来的场景

3、可管理，不要因为键值的构造或维护过程中产生不恰当的管理开销

##### 单键，复合键

单键：主键如果是一个属性，称为单键

复合键：主键如果是多个属性的组合，称为复合键



### 主键和外键

其它表的主键叫做外键。

### 自然键和代理键

自然键：已经真实存在的键，通常具有商业含义，比如身份证ID，护照编码等等。可以是单键也可以是复合键

代理键：完全没有商业含义，通常当下的系统自动生成。都是单键。

注意：

1、在每个代理键为主键的表中，尤其是维度表，必定有自然键作为可选键。绝对不允许仅仅存在一个代理键而没有自然键的现象。

2、代理键绝不可以对用户可见，通常用于Join，而不用于where的搜索条件。代理键的命名规则也要非常明确。

原因：

1. 代理键毫无商业含义，暴露给用户只会误导用户
2. 系统迁移等环境变更，由于代理键是系统自动生成的，会造成相同自然键的代理键不一致
3. 使程序员根据名字能够轻易判断出是否是代理键，避免错误的使用

#### 自然键VS代理键

|          |                            自然键                            |                            代理键                            |
| :------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
|  灵活性  |    主键不可以修改，实体主键变化会带来外键相关表的连锁反应    |            代理键本身无意义，可以修改原自然键内容            |
|  灵活性  |              新系统接入时，合并维度存在一定困难              |               新系统接入时，合并维度表相对简单               |
| 程序编写 | 对于事实表而言，如果需要按照自然键直接搜索，则可以不用关联到维度表 | 由于代理键无法直接作为查询条件，因此必须关联到维度表进行关联查询 |
| 程序编写 |            如果维度表是复合主键，则程序书写更复杂            |                        代理键模式简单                        |
| 存储空间 | 维度表而言，需更少空间；事实表而言，视各个维度键值数据类型而定，通常需要更多空间，总体来看占用空间 | 维度表而言，需要更多空间；事实表而言，视各个维度键值数据类型而定，通常需更少空间，总体来看占用空间更少 |
| 数据加载 | 就维度表而言，直接从源系统过数据，除正常转换外没有额外的开销 |       就维度表而言，代理键插入需计算最新插入的代理键值       |



## 范式建模

### 定义

1、第一范式

原子性，列不可再分，每一列只包含一个属性，所有属性的类型都是一样的，而不能是集合，数组，记录等非原子数据项，即实体中的某个属性有多个值时，必须拆分为不同的属性。这是所有关系型数据库的最基本要求；

2、第二范式

唯一性，一个表只说明一个事物，要求表中的所有列，都必须依赖于主键，而不能有任何一列与主键没有关系，也就是说一个表只描述一件事情；

3、第三范式

每列都与主键有直接关系，属性不能传递依赖于主属性。

3NF在2NF的基础之上，消除了非主属性对于码的传递函数依赖。也就是说， 如果存在非主属性对于码的传递函数依赖，则不符合3NF的要求。

符合第三范式的关系必须具有以下三个条件：

第一、每个属性的值唯一，不具有多义性

第二、每个非主属性必须完全依赖于整个主键，而非主键的一部分

第三、每个非主属性不能依赖于其他关系中的属性，因为这样的话，这种属性应该归到其他关系中去

> 每一个非键值属性必须依赖于键，依赖于整个键而不是键的一部分，并且不依赖于其他非键属性。



## 维度建模

维度建模架构是一种自下而上的架构，它认为数据仓库是一系列数据集市的集合。企业可以通过一系列维数相同的数据集市递增地构建数据仓库，通过使用一致的维度，能够共同看到不同数据集市中的信息，这表示它们拥有公共定义的元素。

这一方法是Kimball最先提出的，其最简单的描述就是，按照事实表、维度表来构建数据仓库、数据集市。在维度建模方法体系中，维度是描述事实的角度，如日期、客户、供应商等，事实是要度量的指标，如客户数、销售额等。

### 星型模型

***星型架构是一种非正规化的结构，多维数据集的每一个维度都直接与事实表相连接，不存在渐变维度，所以数据有一定的冗余***，如在地域维度表中，存在国家 A 省 B 的城市 C 以及国家 A 省 B 的城市 D 两条记录，那么国家 A 和省 B 的信息分别存储了两次，即存在冗余。

![img](https://raw.githubusercontent.com/Jasong321/PicBed/master/202111071127725.png)



### 雪花模型

当有一个或多个维表没有直接连接到事实表上，而是通过其他维表连接到事实表上时，其图解就像多个雪花连接在一起，故称雪花模型。雪花模型是对星型模型的扩展。它对星型模型的维表进一步层次化，原有的各维表可能被扩展为小的事实表，形成一些局部的 " 层次 " 区域，这些被分解的表都连接到主维度表而不是事实表。如图 2，将地域维表又分解为国家，省份，城市等维表。它的优点是 : 通过最大限度地减少数据存储量以及联合较小的维表来改善查询性能。雪花型结构去除了数据冗余。

<img src="https://raw.githubusercontent.com/Jasong321/PicBed/master/202111071127770.png" alt="img" style="zoom:200%;" />



> 总结：星型模型因为数据的冗余所以很多统计查询不需要做外部的连接，因此一般情况下效率比雪花型模型要高。星型结构不用考虑很多正规化的因素，设计与实现都比较简单。雪花型模型由于去除了冗余，有些统计就需要通过表的联接才能产生，所以效率不一定有星型模型高。正规化也是一种比较复杂的过程，相应的数据库结构设计、数据的 ETL、以及后期的维护都要复杂一些。因此在冗余可以接受的前提下，实际运用中星型模型使用更多，也更有效率。

<img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTIwMDc1Ni8yMDIwMDYvMTIwMDc1Ni0yMDIwMDYwNDEzMDY0MDA2Ni0xODMyOTcwOTQ1LnBuZw?x-oss-process=image/format,png" alt="img" style="zoom:200%;" />

## 数仓构建流程

![image-20211107112650451](https://raw.githubusercontent.com/Jasong321/PicBed/master/202111071127106.png)

### 构建总线矩阵

数据仓库总线矩阵是业务需求定义的核心。

维度是总线，必须保障一致性。业务过程可基于一致性维度集成，所以数据仓库总线矩阵是按行增量扩充的。

### 选择业务过程

维度建模的第一步是选择业务过程。从业务重要性和技术可行性两个角度综合判定业务过

程的优先级，优先对既重要又可行的业务过程建模。

### 声明粒度

维度建模的第二步是声明粒度。业务过程的粒度声明得越细，意味着对业务需求的定义越详细。通常与业务过程相对应的业务单据精确地记录了细节，可辅助声明业务过程的最细粒度。



### 确定维度

维度建模的第三步是确定维度。在声明业务过程最细粒度的同时也就确定了与该业务过程相关的维度及属性，而维度属性的结构分包含与并列两种。



### 确定事实

维度建模的第四步是确定事实。在声明粒度和确定维度的基础上，可进一步确定业务过程的度量要素和指标逻辑



### 指标

指标分为原子指标和派生指标。原子指标是对指标统计口径、具体算法的一
个抽象。原生的原子指标：例如支付金额。衍衍生原子指标：基于原子指标组合构建。例如，客单价通过支付金额除以买家数组合而来。

派生指标是以原子指标为基准，组装统计粒度、统计周期及业务限定而生成
的。派生指标是业务中常用的统计指标。为保证统计指标标准、规范、无二义性
地生成，OneData 方法论将派生指标抽象为四部分：<font color=red>派生指标=原子指标+业务限定+统计周期+统计粒度。</font>

 
